name: Model Deployment

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  SHA: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set lowercase repo name
        run: echo "REPO_NAME=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push blue Docker image
        env:
          APP_VERSION: blue 
          MODEL_VERSION: v1.0.0
        run: |
          BLUE_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-blue:$SHA"
          docker build -t "$BLUE_IMAGE" .
          docker push "$BLUE_IMAGE"

      - name: Build and push green Docker image
        env:
          APP_VERSION: green
          MODEL_VERSION: v1.1.0
        run: |
          GREEN_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-green:$SHA"
          docker build -t "$GREEN_IMAGE" .
          docker push "$GREEN_IMAGE"

      - name: Deploy to Cloud
        run: |
          echo "Deploying image"

          BLUE_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-blue:$SHA"
          GREEN_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-green:$SHA"

          curl -fsS -X POST "${{ secrets.CLOUD_DEPLOY_URL }}" \
            -H "Authorization: Bearer ${{ secrets.CLOUD_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "blue_image": "'"$BLUE_IMAGE"'",
              "green_image": "'"$GREEN_IMAGE"'",
              "git_sha": "'"$SHA"'"
            }'

      - name: Wait for health check
        run: |
          HEALTH_URL="${{ secrets.CLOUD_BASE_URL }}/health"

          for i in $(seq 1 60); do
            if curl -fsS "$HEALTH_URL" > /dev/null; then
              echo "Service is running"
              exit 0
            fi
            echo "Waiting for health... ($i/60)"
            sleep 5
          done

          echo "Health check failed"
          exit 1